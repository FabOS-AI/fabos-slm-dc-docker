pipeline {
    agent any
    stages {
        stage("Checkout") {
            steps {
                checkout scm
            }
        }

        stage("Create") {
            steps {
                withCredentials([usernamePassword(
                        credentialsId: 'jenkins_infra_account',
                        usernameVariable: 'VSPHERE_USER',
                        passwordVariable: 'VSPHERE_PASSWORD'
                )]) {
                    sh "cd ./roles/setup && molecule reset -s install && molecule create -s install"
                }
            }
        }

        stage("Tests") {
            parallel {
                stage("Ubuntu") {
                    agent {
                        docker {
                            image 'fabos4ai/molecule:4.0.1'
                            args '-u root'
                        }
                    }

                    stages {
                        stage("Requirements") {

                            steps {
                                withCredentials([usernamePassword(
                                        credentialsId: 'jenkins_infra_account',
                                        usernameVariable: 'VSPHERE_USER',
                                        passwordVariable: 'VSPHERE_PASSWORD'
                                )]) {
                                    sh 'ansible-galaxy install -f -r requirements.yml'
                                }
                            }

                        }

                        stage("Test Install") {
                            steps {
                                withCredentials([usernamePassword(
                                        credentialsId: 'jenkins_infra_account',
                                        usernameVariable: 'VSPHERE_USER',
                                        passwordVariable: 'VSPHERE_PASSWORD'
                                )]) {
                                    //sh 'cd ./roles/setup && molecule converge -s install-ubuntu && molecule verify -s install-ubuntu'
                                    sh 'cd ./roles/setup && molecule test -s install-ubuntu -p ubuntu2204 --destroy never'
                                }
                            }
                        }

                        stage("Test Deploy") {
                            steps {
                                withCredentials([usernamePassword(
                                        credentialsId: 'jenkins_infra_account',
                                        usernameVariable: 'VSPHERE_USER',
                                        passwordVariable: 'VSPHERE_PASSWORD'
                                )]) {
                                    sh 'cd ./roles/use && molecule test -s deploy-ubuntu -p ubuntu2204 --destroy never'
                                }
                            }
                        }

                        stage("Test Undeploy") {
                            steps {
                                withCredentials([usernamePassword(
                                        credentialsId: 'jenkins_infra_account',
                                        usernameVariable: 'VSPHERE_USER',
                                        passwordVariable: 'VSPHERE_PASSWORD'
                                )]) {
                                    sh 'cd ./roles/use && molecule test -s undeploy-ubuntu -p ubuntu2204 --destroy never'
                                }
                            }
                        }

                        stage("Test Uninstall") {
                            steps {
                                withCredentials([usernamePassword(
                                        credentialsId: 'jenkins_infra_account',
                                        usernameVariable: 'VSPHERE_USER',
                                        passwordVariable: 'VSPHERE_PASSWORD'
                                )]) {
                                    sh 'cd ./roles/setup && molecule test -s uninstall-ubuntu -p ubuntu2204 --destroy never'
                                }
                            }
                        }
                    }
                }
                stage("CentOS") {
                    agent {
                        docker {
                            image 'fabos4ai/molecule:4.0.1'
                            args '-u root'
                        }
                    }

                    stages {
                        stage("Requirements") {
                            steps {
                                withCredentials([usernamePassword(
                                        credentialsId: 'jenkins_infra_account',
                                        usernameVariable: 'VSPHERE_USER',
                                        passwordVariable: 'VSPHERE_PASSWORD'
                                )]) {
                                    sh 'ansible-galaxy install -f -r requirements.yml'
                                }
                            }
                        }

                        stage("Test Install") {
                            steps {
                                withCredentials([usernamePassword(
                                        credentialsId: 'jenkins_infra_account',
                                        usernameVariable: 'VSPHERE_USER',
                                        passwordVariable: 'VSPHERE_PASSWORD'
                                )]) {
                                    sh 'cd ./roles/setup && molecule test -s install-centos -p centos8 --destroy never'
                                }
                            }
                        }

                        stage("Test Deploy") {
                            steps {
                                withCredentials([usernamePassword(
                                        credentialsId: 'jenkins_infra_account',
                                        usernameVariable: 'VSPHERE_USER',
                                        passwordVariable: 'VSPHERE_PASSWORD'
                                )]) {
                                    sh 'cd ./roles/use && molecule test -s deploy-centos -p centos8 --destroy never'
                                }
                            }
                        }

                        stage("Test Undeploy") {
                            steps {
                                withCredentials([usernamePassword(
                                        credentialsId: 'jenkins_infra_account',
                                        usernameVariable: 'VSPHERE_USER',
                                        passwordVariable: 'VSPHERE_PASSWORD'
                                )]) {
                                    sh 'cd ./roles/use && molecule test -s undeploy-centos -p centos8 --destroy never'
                                }
                            }
                        }

                        stage("Test Uninstall") {
                            steps {
                                withCredentials([usernamePassword(
                                        credentialsId: 'jenkins_infra_account',
                                        usernameVariable: 'VSPHERE_USER',
                                        passwordVariable: 'VSPHERE_PASSWORD'
                                )]) {
                                    sh 'cd ./roles/setup && molecule test -s uninstall-centos -p centos8 --destroy never'
                                }
                            }
                        }


                    }
                }

                stage("Destroy") {
                    steps {
                        withCredentials([usernamePassword(
                                credentialsId: 'jenkins_infra_account',
                                usernameVariable: 'VSPHERE_USER',
                                passwordVariable: 'VSPHERE_PASSWORD'
                        )]) {
                            sh 'cd ./roles/setup && molecule destroy -s install'
                        }
                    }
                }

            }
        }
    }
}